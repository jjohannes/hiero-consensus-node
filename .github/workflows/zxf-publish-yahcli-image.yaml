# SPDX-License-Identifier: Apache-2.0
name: "ZXC: Publish Yahcli Image"
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git Reference - branch, tag, or commit SHA."
        type: string
        required: true
      dry-run-enabled:
        description: "Perform Dry Run"
        type: boolean
        required: false
        default: false
      java-distribution:
        description: "Java JDK Distribution:"
        type: string
        required: false
        default: "temurin"
      java-version:
        description: "Java JDK Version:"
        type: string
        required: false
        default: "21.0.6"
      gradle-version:
        description: "Gradle Version:"
        type: string
        required: false
        default: "wrapper"
      custom-job-name:
        description: "Custom Job Name:"
        required: false
        type: string
        default: "Publish Yahcli Image"

defaults:
  run:
    shell: bash

env:
  LC_ALL: C.UTF-8

permissions:
  id-token: write
  contents: read

jobs:
  publish-yahcli-image:
    name: ${{ inputs.custom-job-name || 'Publish Yahcli Image' }}
    runs-on: ubuntu-latest
    outputs:
      docker-image: ${{ steps.set-registry.outputs.docker-tag-base }}/yahcli:${{ steps.resolve-version.outputs.version }}
      docker-image-tag: ${{ steps.resolve-version.outputs.version }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}
          token: ${{ github.token }}

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: ${{ inputs.java-distribution || 'temurin' }}
          java-version: ${{ inputs.java-version || '21.0.6' }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          gradle-version: ${{ inputs.gradle-version || 'wrapper' }}

      - name: Resolve Version
        id: resolve-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            echo "version=${VERSION}" >>"${GITHUB_OUTPUT}"
            echo "Resolved version from tag: ${VERSION}"
          else
            VERSION="$(./gradlew showVersion --quiet 2>/dev/null | tr -d '[:space:]')"
            echo "version=${VERSION}" >>"${GITHUB_OUTPUT}"
            echo "Resolved version from Gradle: ${VERSION}"
          fi

      - name: Build Yahcli Shadow JAR
        run: ./gradlew :yahcli:yahCliJar

      - name: Stage Yahcli Assets
        run: |
          SHADOW_JAR="$(ls -1 hedera-node/yahcli/build/libs/*-shadow.jar 2>/dev/null | head -n1)"
          if [[ -z "${SHADOW_JAR}" ]]; then
            echo "::error::Yahcli shadow JAR not found in hedera-node/yahcli/build/libs/"
            exit 1
          fi
          cp -f "${SHADOW_JAR}" hedera-node/yahcli/assets/yahcli.jar
          echo "Staged yahcli.jar from ${SHADOW_JAR} ($(du -h hedera-node/yahcli/assets/yahcli.jar | cut -f1))"

      - name: Authenticate to Google Cloud
        id: google-auth
        uses: step-security/google-github-auth@40f6deebd366f16c782d7a0ad0844e3b96a032a6 # v2.1.10
        if: ${{ inputs.dry-run-enabled != true && !cancelled() && !failure() }}
        with:
          token_format: "access_token"
          workload_identity_provider: "projects/235822363393/locations/global/workloadIdentityPools/hedera-builds-pool/providers/hedera-builds-gh-actions"
          service_account: "swirlds-automation@hedera-registry.iam.gserviceaccount.com"

      - name: Set Image Registry
        id: set-registry
        run: |
          DOCKER_REGISTRY="gcr.io"
          DOCKER_TAG_BASE="gcr.io/hedera-registry"

          if [[ "${{ inputs.dry-run-enabled }}" == "true" ]]; then
            DOCKER_TAG_BASE="localhost:5000"
          fi

          echo "docker-registry=${DOCKER_REGISTRY}" >>"${GITHUB_OUTPUT}"
          echo "docker-tag-base=${DOCKER_TAG_BASE}" >>"${GITHUB_OUTPUT}"

      - name: Setup QEmu Support
        uses: docker/setup-qemu-action@5964de0df58d5ad28b04d8fe2e6b80ad47105b91 # v3.5.0

      - name: Setup Docker Buildx Support
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
        with:
          version: v0.16.2
          driver-opts: network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["https://hub.mirror.docker.lat.ope.eng.hashgraph.io"]

      - name: Setup Local Docker Registry
        if: ${{ inputs.dry-run-enabled == true && !cancelled() && !failure() }}
        run: docker run -d -p 5000:5000 --restart=always --name registry registry:latest

      - name: Docker Login
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        if: ${{ inputs.dry-run-enabled != true && !cancelled() && !failure() }}
        with:
          registry: ${{ steps.set-registry.outputs.docker-registry }}
          username: oauth2accesstoken
          password: ${{ steps.google-auth.outputs.access_token }}

      - name: Build Yahcli Image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: true
          no-cache: true
          platforms: linux/amd64,linux/arm64
          context: hedera-node/yahcli
          tags: ${{ steps.set-registry.outputs.docker-tag-base }}/yahcli:${{ steps.resolve-version.outputs.version }}

      - name: Render Job Summary
        run: |
          VERSION="${{ steps.resolve-version.outputs.version }}"
          YAHCLI_LINK="Not Applicable"

          if [[ "${{ inputs.dry-run-enabled }}" != true ]]; then
            YAHCLI_LINK="[GCP Console](https://${{ steps.set-registry.outputs.docker-tag-base }}/yahcli:${VERSION})"
          fi

          printf "### Published Docker Images\n" >> "${GITHUB_STEP_SUMMARY}"
          printf "| Image Name | Version | URL | Supported Architectures |\n" >> "${GITHUB_STEP_SUMMARY}"
          printf "| ---------- | ------- | --- | ----------------------- |\n" >> "${GITHUB_STEP_SUMMARY}"

          printf "| %s | %s | %s | %s |\n" \
            "${{ steps.set-registry.outputs.docker-tag-base }}/yahcli" \
            "${VERSION}" \
            "${YAHCLI_LINK}" \
            "linux/amd64, linux/arm64" >> "${GITHUB_STEP_SUMMARY}"

          printf "\n\n" >> "${GITHUB_STEP_SUMMARY}"
